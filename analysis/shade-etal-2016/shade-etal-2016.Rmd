---
title: "shade-etal-2016"
author: "rogilmore"
date: "`r Sys.time()`"
output: html_document
---

This document depicts a series of visualizations and analyses that build upon the the Vedak et al. (2015) presentation at the Vision Sciences Society 2015 meeting.

Vedak, S.C, Gilmore, R.O., Kohler, P.J., Liu, Y., & Norcia, A.M. (2015, May). The salience of lower-order features in highly similar wallpaper groups. Poster presented at the Vision Sciences Society meeting, St. Pete Beach, FL.

Gilmore, R.O., & Norcia, A.M. (2014). The Salience of Lower-Order, Localized Features in Highly Self-Similar Wallpaper Groups. Databrary. Retrieved May 18, 2015 from <http://databrary.org/volume/77>.

## Set-up

```{r set-libraries-paths-externals}
require(ggplot2)
require(dplyr)
require(xlsx)
require(lme4)

path.2.this.analysis <- 'shade-etal-2016'
path.2.xlsx <- '../../xlsx' # from shade-etal-2016/
data.xlsx <- 'Raw_Sorting_Data_151102.xlsx'
wallpaper.groups <- c('P1', 'P3M1', 'P31M', 'P6', 'P6M')

source("jaccard.data.R")
source("jaccard.R")
```

## Import raw data and calculate Jaccard indices

Raw data were captured as Excel spreadsheets. These can be found in [symmetry-sorting/xlsx/](../xlsx).

```{r import-clean-raw}

P1.df <- read.xlsx(paste(path.2.xlsx, data.xlsx, sep="/"), sheetName = wallpaper.groups[1])
P3M1.df <- read.xlsx(paste(path.2.xlsx, data.xlsx, sep="/"), sheetName = wallpaper.groups[2])
P31M.df <- read.xlsx(paste(path.2.xlsx, data.xlsx, sep="/"), sheetName = wallpaper.groups[3])
P6.df <- read.xlsx(paste(path.2.xlsx, data.xlsx, sep="/"), sheetName = wallpaper.groups[4])
P6M.df <- read.xlsx(paste(path.2.xlsx, data.xlsx, sep="/"), sheetName = wallpaper.groups[5])

# Rename NSets column
names(P1.df)[23]<-"Nsets"
names(P3M1.df)[23]<-"Nsets"
names(P31M.df)[23]<-"Nsets"
names(P6.df)[23]<-"Nsets"
names(P6M.df)[23]<-"Nsets"

# Rename exemplars
names(P1.df)[3:22]<-c(as.character(1:20))
names(P3M1.df)[3:22]<-c(as.character(1:20))
names(P31M.df)[3:22]<-c(as.character(1:20))
names(P6.df)[3:22]<-c(as.character(1:20))
names(P6M.df)[3:22]<-c(as.character(1:20))

# Merge into data frame
n.sets.df <- rbind(P1.df, P3M1.df, P31M.df, P6.df, P6M.df)

n.sets.df$Group <- c(rep('P1', dim(P1.df)[1]), 
                             rep('P3M1', dim(P3M1.df)[1]),
                             rep('P31M', dim(P31M.df)[1]),
                             rep('P6', dim(P6.df)[1]),
                             rep('P6M', dim(P6M.df)[1])
                            )
```

```{r calculate-jaccard}
# Calculate Jaccard indices, then merge

P1.jaccard <- jaccard.data(P1.df)
P3M1.jaccard <- jaccard.data(P3M1.df)
P31M.jaccard <- jaccard.data(P31M.df)
P6.jaccard <- jaccard.data(P6.df)
P6M.jaccard <- jaccard.data(P6M.df)

jaccard.nodups <- rbind(P1.jaccard, P3M1.jaccard, P31M.jaccard, P6.jaccard, P6M.jaccard)

jaccard.df <- data_frame(Exemplar.Row = jaccard.nodups[,1], 
                                Exemplar.Col = jaccard.nodups[,2], 
                                Jaccard = jaccard.nodups[,3])

jaccard.df$Group <- c(rep('P1', dim(P1.jaccard)[1]), 
                             rep('P3M1', dim(P3M1.jaccard)[1]),
                             rep('P31M', dim(P31M.jaccard)[1]),
                             rep('P6', dim(P6.jaccard)[1]),
                             rep('P6M', dim(P6M.jaccard)[1])
                            )
```

## Jaccard indices across exemplars, participants

### Histogram
```{r, echo=FALSE}
theme.symm <- theme( axis.title.x = element_text(size=18),
                       axis.title.y = element_text(size=18),
                       strip.text = element_text(size=16),
                       axis.text = element_text(size=14),
                       legend.text = element_text(size=14),
                       legend.title = element_text(size=14)
)

qplot(x=Jaccard, 
      data=jaccard.df, 
      geom=c("histogram"), 
      facets = Group ~ ., fill=Group ) + 
  labs( x="Jaccard Index", y="N observations") +
  theme.symm +
  guides( fill=FALSE )
```

## Jaccard indices by exemplar

```{r}
# Re-read data files to includes a,b and b,a scores for each
# exemplar pair. Of course j(a,b)=j(b,a), but we need both scores to show 
# exemplar-by-exemplar patterns. In the future, just do this then filter.

P1.jaccard <- jaccard.data(P1.df, duplicates=TRUE)
P3M1.jaccard <- jaccard.data(P3M1.df, duplicates=TRUE)
P31M.jaccard <- jaccard.data(P31M.df, duplicates=TRUE)
P6.jaccard <- jaccard.data(P6.df, duplicates=TRUE)
P6M.jaccard <- jaccard.data(P6M.df, duplicates=TRUE)

jaccard.all <- rbind(P1.jaccard, P3M1.jaccard, P31M.jaccard, P6.jaccard, P6M.jaccard)

jaccard.all.df <- data_frame(Exemplar.Row = jaccard.all[,1], 
                                Exemplar.Col = jaccard.all[,2], 
                                Jaccard = jaccard.all[,3])

jaccard.all.df$Group <- c(rep('P1', dim(P1.jaccard)[1]), 
                             rep('P3M1', dim(P3M1.jaccard)[1]),
                             rep('P31M', dim(P31M.jaccard)[1]),
                             rep('P6', dim(P6.jaccard)[1]),
                             rep('P6M', dim(P6M.jaccard)[1])
                      )

#jaccard.all.df <- read.csv("jaccard-all.csv")

# Select a,b and b,a but not a,a pairs
jaccard.select <- with(jaccard.all.df, !(Exemplar.Row==Exemplar.Col))
```

### Boxplot

```{r, echo=FALSE}
qplot(data=jaccard.all.df[jaccard.select,],
      x=as.factor(Exemplar.Row), y=Jaccard,
      facets = Group ~ .,
      fill=Group, 
      geom="boxplot",
      xlab = "Exemplar")
```

### Means, Medians, SE by exemplar
```{r}
jaccard.trim.df <- jaccard.all.df[jaccard.select,]
jaccard.trim.summ <- jaccard.trim.df %>%
  group_by(Group, Exemplar.Row) %>%
  summarize( Jaccard.mean=mean(Jaccard),
             Jaccard.sem=mean(Jaccard)/sqrt(n()),
             Jaccard.med=median(Jaccard))

jaccard.trim.best <- jaccard.trim.summ %>%
  group_by( Group ) %>%
  summarize(Jaccard.max.mean=max(Jaccard.mean),
            Jaccard.max.med=max(Jaccard.med),
            Jaccard.min.mean=min(Jaccard.mean),
            Jaccard.min.med=min(Jaccard.med),
            Jaccard.min.sem=min(Jaccard.sem))

jaccard.stats <- merge(jaccard.trim.summ, jaccard.trim.best, by.x="Group", by.y="Group")

jaccard.stats <- jaccard.stats %>%
  mutate( Max.mean = (Jaccard.mean==Jaccard.max.mean), 
          Min.mean = (Jaccard.mean==Jaccard.min.mean),
          Max.med = (Jaccard.med==Jaccard.max.med),
          Min.sem = (Jaccard.sem==Jaccard.min.sem)
)
```

#### Max mean and max median
```{r}
jaccard.stats %>%
  filter( Max.mean, Max.med ) %>%
  select( Group, Exemplar.Row, Jaccard.mean, Jaccard.med )
```

#### Max median and min sem
```{r}
jaccard.stats %>%
  filter( Max.med, Min.sem ) %>%
  select( Group, Exemplar.Row, Jaccard.mean, Jaccard.med )
```

#### Max mean and min sem
```{r}
jaccard.stats %>%
  filter( Max.med, Min.sem ) %>%
  select( Group, Exemplar.Row, Jaccard.mean, Jaccard.med )
```

#### Max mean only
```{r}
jaccard.stats %>%
  filter( Max.mean ) %>%
  select( Group, Exemplar.Row, Jaccard.mean, Jaccard.med )
```

#### Max med, but look at low sem
```{r}
jaccard.stats %>%
  filter( Max.med ) %>%
  select( Group, Exemplar.Row, Jaccard.mean, Jaccard.med, Jaccard.sem ) %>%
  arrange( Group, Jaccard.sem )
```

### Linear mixed effects model on Jaccard

Fixed effect of group, random intercept for Group:Exemplar combination.

```{r}
jaccard.lme <- lmer( data=jaccard.trim.df, Jaccard ~ Group + (1|Exemplar.Row:Group))
summary(jaccard.lme)
jaccard.ci <- confint(jaccard.lme)
jaccard.reduced.lme <- lmer( data=jaccard.trim.df, Jaccard ~ (1|Exemplar.Row:Group))
anova( jaccard.lme, jaccard.reduced.lme )

# Or, for traditionalists
anova(jaccard.lme)
```

Full model has better fit $\chi^{2}(df=4)=93.431, p<2.2e-16$

#### Plot of effects CI

```{r plot-ci-mean-jaccard}
# rows 1 and 2 have values we don't care about
Jacc.vals <- c( jaccard.ci[3:7,1], jaccard.ci[3:7,2] )
J.offset <-c(0, rep( jaccard.ci[3,1],4), 0, rep(jaccard.ci[3,2],4) )
Jacc.fitted <- Jacc.vals + J.offset
Group <- rep( c("P1", "P31M", "P3M1", "P6", "P6M"), 2)
LowHigh <- rep(c("Low","High"), each=5)
jaccard.ci.df <- data.frame(Group, Jacc.fitted, LowHigh, row.names=NULL)
qplot( data=jaccard.ci.df, x=Group, y=Jacc.fitted, color=Group, geom="line", group=Group) +
  labs(x="Group", y="95% CI for Mean Jaccard") + theme.symm + guides(color=FALSE)
```

## Number of sets

### Dotplot

```{r dotplot-Nsets}
qplot(data=n.sets.df, x=Nsets, geom=c("dotplot"), facets=Group ~ ., dotsize=.07, fill=Group ) +
  labs( x="Number of Sets", y="") +
  theme.symm +
  theme( axis.text.y = element_blank() ) +
  scale_y_continuous(breaks=NULL) +
  guides( fill=FALSE )
```

### Linear mixed-effects model

Fixed effect of Group, random effect for Participant.

```{r}
n.sets.lme <- lmer( data=n.sets.df, Nsets ~ Group + (1|Participant))
summary(n.sets.lme)

# drop Group
n.sets.reduced.lme <- lmer( data=n.sets.df, Nsets ~ (1|Participant) )
anova( n.sets.lme, n.sets.reduced.lme )

# Or, for traditionalists
anova(jaccard.lme)
```

Fuller model better fitting $\chi^{2}(df=4)=9.7039, p=.04572$. So, there are differences in the number of sets. P1 smallest, P6 largest.